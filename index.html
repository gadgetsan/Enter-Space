<html>
	<head>
		<title>My first Three.js app</title>
		<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
		<style>
			body { margin: 0; }
			canvas { width: 10%; height: 10% }
			#inventory{
					width:272px;
					height:272px;
					background-color:rgba(255, 255, 255, .5);
					border: solid 1px #999999;
					position:fixed;
					margin-left:-136px; /* half of width */
					margin-top:-136px;  /* half of height */
					top:50%;
					left:50%;
			}
			.item{
					padding:0px;
					margin: 0px;
					width:30px;
					height:30px;
					filter: hue-rotate(30deg);
					-webkit-filter: hue-rotate(30deg);
			}
			.quantity{
					padding:0px;
					margin: 0px;
					position:relative;
					font-family: 'Roboto', sans-serif;
					color: #FFFFFF;
					font-size: 12px;
					text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
					top: -14px;
					left: 2px;
			}
			#inventory div{
					padding:0px;
					margin: 0px;
			}

			#inventory li {
					width: 30px;
					height: 30px;
					border: 1px solid #999999;
					display: -moz-inline-stack;
					display: inline-block;
					vertical-align: middle;
					text-align: middle;
					margin: 1px;
					padding: 0px;
					*display: inline;
			}
			.crosshair1 {
			    position:fixed;
			    top: 50%;
			    left: 50%;
			    width:20px;
			    height:2px;
			    margin-top: 9px; /*set to a negative number 1/2 of your height*/
			    margin-left: 0px; /*set to a negative number 1/2 of your width*/
				background-color:rgba(255, 255, 255, 0.5);
			}
			.crosshair2 {
			    position:fixed;
			    top: 50%;
			    left: 50%;
			    width:2px;
			    height:20px;
			    margin-top: 0px; /*set to a negative number 1/2 of your height*/
			    margin-left: 9px; /*set to a negative number 1/2 of your width*/
				background-color:rgba(255, 255, 255, 0.5);
			}
		</style>
	</head>
	<body>
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
		<script src="external/js/three.min.js"></script>
        <script src="external/js/FirstPersonControls.js"></script>
        <script src="external/js/PointerLockControls.js"></script>
        <script src="external/js/MarchingCubes.js"></script>
        <!--<script src="external/physijs/physi.js"></script>-->
		<script src="external/js/cannon.js"></script>
		<script src="external/js/seedrandom.js"></script>

		<div id="blocker">

			<div id="instructions">
				<span style="font-size:40px">Appuyez ici</span>
				<br />
				(W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
			</div>
		</div>
		<div class="crosshair1"></div>
		<div class="crosshair2"></div>



    <script src="src/World.js"></script>
    <script src="src/Utilities.js"></script>
    <script src="src/Elements.js"></script>
    <script src="src/MarchingCube.js"></script>
    <script src="src/Factory.js"></script>
    <script src="src/Chunk.js"></script>
    <script src="src/Chunks.js"></script>
    <script src="src/Planet.js"></script>
    <script src="src/Keyboard.js"></script>
    <script src="src/Workers/ChunkGenManager.js"></script>
    <script src="src/Workers/WorkersManager.js"></script>
    <script src="src/Features/Caves.js"></script>
    <script src="src/Features/Ores.js"></script>
    <script src="src/Features/Ice.js"></script>
    <script src="src/Features/Water.js"></script>


		<!--
		<script src="external/js/interact-1.2.4.min.js"></script>
		<script src="src/Inventory.js"></script>

				</div>
				<div id="inventory">
				</div>
		<script>

		var inventory;
		$( document ).ready(function() {
			inventory = new Inventory();
			inventory.addItem("sqr", 9999, 10);
			inventory.addItem("sqr", 8888, 20);
			inventory.addItem("sqr", 1, 10);
		});

	</script>-->
	<script>





	WORLDELEMENTS.GenerateNames();
        var generateSphereMap = function(size, center, radius){
          var map = [];

  				var size = size;
  				var center = center;
  				var ray = radius;
  				for(var i = 0; i<size; i++){
  				  map.push([]);
      				for(var j = 0; j<size; j++){
  				      map[i].push([]);
            			for(var k = 0; k<size; k++){
            			  //console.log((i-center)*(i-center) + (j-center)*(j-center) + (k-center)*(k-center));
          				  if(((i-center)*(i-center) + (j-center)*(j-center) + (k-center)*(k-center)) < (ray*ray) /*&& (j < center-(ray/2) || j > center+(ray/2) || k < center-(ray/2) || k > center+(ray/2))*/){
          				    map[i][j].push(1);
          				  }else{
          				    map[i][j].push(0);
          				  }
          				}
      				}
  				}
  				return map;
        }

        var buildSquareGeometry = function (size, peak) {
            var square = new THREE.Geometry();

            square.vertices.push(new THREE.Vector3(0, 0, 0));
            square.vertices.push(new THREE.Vector3(0, 0, size));
            square.vertices.push(new THREE.Vector3(size, 0, size));
            square.vertices.push(new THREE.Vector3(size, 0, 0));

            square.vertices.push(new THREE.Vector3(0, peak, 0));
            square.vertices.push(new THREE.Vector3(0, peak, size));
            square.vertices.push(new THREE.Vector3(size, peak, size));
            square.vertices.push(new THREE.Vector3(size, peak, 0));

            square.faces.push(new THREE.Face3(4, 5, 6));
            square.faces.push(new THREE.Face3(4, 6, 7));

            square.faces.push(new THREE.Face3(0, 1, 4));
            square.faces.push(new THREE.Face3(4, 1, 5));

            square.faces.push(new THREE.Face3(1, 2, 5));
            square.faces.push(new THREE.Face3(5, 2, 6));


            return square;
        }

        var buildPeakGeometry = function (size, peak) {
            var square = new THREE.Geometry();

            square.vertices.push(new THREE.Vector3(0, 0, 0));
            square.vertices.push(new THREE.Vector3(0, 0, size));
            square.vertices.push(new THREE.Vector3(size, 0, size));
            square.vertices.push(new THREE.Vector3(size, 0, 0));

            square.vertices.push(new THREE.Vector3(size/2, peak, size/2));

            square.faces.push(new THREE.Face3(1, 4, 0));
            square.faces.push(new THREE.Face3(2, 4, 1));
            square.faces.push(new THREE.Face3(3, 4, 2));
            square.faces.push(new THREE.Face3(0, 4, 3));

            return square;
        }

		var randomColor = function(){
		  return Math.floor(Math.random()*16777215)
		}

		var WIDTH = window.innerWidth,
	  	HEIGHT = window.innerHeight,
	  	ASPECT = WIDTH / HEIGHT,
	  	UNITSIZE = 1,
	  	WALLHEIGHT = UNITSIZE / 3,
	  	MOVESPEED = 100,
	  	LOOKSPEED = 0.075,
	  	BULLETMOVESPEED = MOVESPEED * 5,
	  	NUMAI = 5,
	  	PROJECTILEDAMAGE = 20;

		//var scene = new Physijs.Scene;
		var scene = new THREE.Scene;

		// Setup our world
		var world = new CANNON.World();
		//world.gravity.set(0, -9.82, 0); // m/s²
		world.gravity.set(0, -9.82, 0); // m/s²
        //world.broadphase = new CANNON.NaiveBroadphase();

        // Create a slippery material (friction coefficient = 0.0)
        // Materials
        var groundMaterial = new CANNON.Material("groundMaterial");
        // Adjust constraint equation parameters for ground/ground contact
        var ground_ground_cm = new CANNON.ContactMaterial(groundMaterial, groundMaterial, {
            friction: 0.4,
            restitution: 0.3,
            contactEquationStiffness: 1e8,
            contactEquationRelaxation: 3,
            frictionEquationStiffness: 1e8,
            frictionEquationRegularizationTime: 3,
        });
        // Add contact material to the world
        world.addContactMaterial(ground_ground_cm);

		//scene.setGravity(new THREE.Vector3( 0, -15, 0 ));
		var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 100000 );
	    var clock = new THREE.Clock(); // Used in render() for controls.update()

			// Camera moves with mouse, flies around with WASD/arrow keys
    	controls = new THREE.PointerLockControls(camera); // Handles camera control
		scene.add( controls.getObject() );
		var ctrlObj = controls.getObject();
		/*
    	controls.movementSpeed = MOVESPEED; // How fast the player can walk around
    	controls.lookSpeed = LOOKSPEED; // How fast the player can look around with the mouse
    	//controls.lookVertical = false; // Don't allow the player to look up or down. This is a temporary fix to keep people from flying
    	//controls.noFly = true; // Don't allow hitting R or F to go up or down
    	//scene.add(camera);
		*/
		var block;

			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth/10, window.innerHeight/10 );

			renderer.shadowMapEnabled = true;
			renderer.shadowMapSoft = true;

			renderer.shadowCameraNear = 1;
			renderer.shadowCameraFar = 100000;
			renderer.shadowCameraFov = 0;

			renderer.shadowMapBias = 0.0039;
			renderer.shadowMapDarkness = 0.5;
			renderer.shadowMapWidth = 8;
			renderer.shadowMapHeight = 8;

			//renderer.setClearColor( 0x000000, 1 );
			document.body.appendChild( renderer.domElement )/10;


			var geometry = new THREE.BoxGeometry( 5,5, 5 );
			var material = new THREE.MeshLambertMaterial({ color: randomColor() });

			var perlinScaling = 10;
			var startingLocation = [1000, 500, 1025];
			var chunkSize = 35;
		  var planet = new Planet(chunkSize, startingLocation);
		  //planet.AddToScene(scene);


			var cube = new THREE.Mesh( geometry, material );
			//scene.add( cube );

			camera.position.z = 0;

      // add subtle blue ambient lighting
			var
				hemiLight = new THREE.HemisphereLight( 0xffffff, 0xffffff, 0.6 );
				hemiLight.color.setHSL( 0.6, 1, 0.6 );
				hemiLight.groundColor.setHSL( 0.095, 1, 0.75 );
				hemiLight.position.set( 0, -500, 0 );
				//scene.add( hemiLight );

            var dirLight = new THREE.DirectionalLight( 0xffffff, 1 );
            //dirLight.position.set( -1, 0.75, 1 );
            dirLight.position.multiplyScalar( 50);
            dirLight.name = "dirlight";
			dirLight.castShadow = true;
            dirLight.shadowCameraVisible = true;

    		dirLight.shadowCameraNear = 1;
    		dirLight.shadowCameraFar = 100000;
			dirLight.shadowDarkness = 0.9;
    		dirLight.shadowMapWidth = dirLight.shadowMapHeight = 512;

            scene.add( dirLight );

  	var blockSize = 2;
	var block_geometry = new THREE.SphereGeometry( blockSize);
	var block = new THREE.Mesh( block_geometry, material, 25, 50, 50 );
	//var block = new Physijs.BoxMesh( block_geometry, material, 25, 50, 50 );
	//var block = new Physijs.BoxMesh( block_geometry, material, 0, 0, 0 );

	var radius = blockSize; // m
	var sphereBody = new CANNON.Body({
	   mass: 50, // kg
	   position: new CANNON.Vec3(startingLocation[0], startingLocation[1], startingLocation[2]), // m
	   shape: new CANNON.Sphere(radius),
	   material: ground_ground_cm
	});
	world.addBody(sphereBody);

var fixedTimeStep = 1.0/60.0;//1.0 / 60.0; // seconds
//world.solver.iterations = 20; // Increase solver iterations (default is 10)
//world.solver.tolerance = 0;   // Force solver to use all iterations
var maxSubSteps = 5;


	block.position.x = startingLocation[0] +(chunkSize/2);
	block.position.y = startingLocation[1]+(chunkSize/2);
	block.position.z = startingLocation[2]+(chunkSize/2);
	scene.add(block);


	var spotlight = new THREE.SpotLight(0xffffff);

	spotlight.castShadow = true;

	spotlight.shadowMapWidth = 8;
	spotlight.shadowMapHeight = 8;

	spotlight.shadowCameraNear = 500;
	spotlight.shadowCameraFar = 4000;
	spotlight.shadowCameraFov = 30;
	//scene.add(spotlight);

	var rad = 1.5;
	var radIncrement =0;// 0.001;


	dirLight.position.y = block.position.y;
	dirLight.position.x = block.position.x;
			var render = function () {
				rad+=radIncrement;
				requestAnimationFrame( render );
				var delta = clock.getDelta()
				//dirLight.position.x += 0.1;

				cube.rotation.x += 0.01;
				cube.rotation.y += 0.1;
				//controls.update(delta);

				renderer.render(scene, camera);
				renderer.setClearColor( 0x3399FF, 1 );
				//scene.simulate();


  				//console.log("Sphere y position: " + sphereBody.position.y);
				ctrlObj.position.copy(sphereBody.position);
				//ctrlObj.quaternion.copy(sphereBody.quaternion);
				block.position.copy(sphereBody.position);
				block.quaternion.copy(sphereBody.quaternion);

				dirLight.position.y =block.position.y+Math.sin(rad)*1000;
				dirLight.position.z =block.position.z+Math.cos(rad)*1000;

				var blue = (Math.sin(rad));
				var green = (Math.sin(rad));
				var red = (Math.sin(rad)+0.3);
				var clearColor = new THREE.Color( red, green, blue );
				renderer.setClearColor( clearColor, 1 );
				dirLight.color = clearColor;

dirLight.target = block;

				if(!stop)
	     			world.step(fixedTimeStep, delta, maxSubSteps);
/*
				ctrlObj.position.x = block.position.x;
				ctrlObj.position.y = block.position.y;
				ctrlObj.position.z = block.position.z;
*/

				var Frontdirection = controls.getDirection(new THREE.Vector3(1,0,0));
				var Leftdirection = new THREE.Vector3(0,0,0);

				var lookAtVector = new THREE.Vector3(0,0, -1);
				lookAtVector.applyQuaternion(camera.quaternion);
				var location = new THREE.Vector3(0,0,0);
				location.copy(Frontdirection);
				location.multiplyScalar(10);
				location.add(ctrlObj.position);
				cube.position.copy(location);
				planet.highlightClosest(ctrlObj.position, Frontdirection);



				spotlight.position.x = block.position.x;
				spotlight.position.y = block.position.y+100;
				spotlight.position.z = block.position.z;
				spotlight.lookAt(block);
				//console.log(lookAtVector)

				Frontdirection.y = 0;

				Leftdirection.crossVectors(Frontdirection, new THREE.Vector3(0,1,0));
				var force = 10;//10;
				if ( moveForward ) sphereBody.velocity.set(Frontdirection.x*force,sphereBody.velocity.y,Frontdirection.z*force);
				if ( moveBackward ) sphereBody.velocity.set(Frontdirection.x*-force,sphereBody.velocity.y,Frontdirection.z*-force);
				if ( moveLeft ) sphereBody.velocity.set(Leftdirection.x*-force,sphereBody.velocity.y,Leftdirection.z*-force);
				if ( moveRight ) sphereBody.velocity.set(Leftdirection.x*force,sphereBody.velocity.y,Leftdirection.z*force);
				if(!moveForward && !moveBackward && !moveLeft && !moveRight){
					sphereBody.velocity.set(0,sphereBody.velocity.y,0)
				}


				planet.Update(scene, ctrlObj, delta);

			};


			render();



		</script>
	</body>
</html>
